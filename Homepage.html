<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SeMoRecepts – Mijn recepten</title>
  <link rel="stylesheet" href="./style.css"/>
</head>
<body>

<header class="p-header">
  <div class="p-bar">
    <div class="p-brand"><span class="p-dot"></span> SeMoRecepts</div>
    <div class="p-search">
      <input id="q" type="search" placeholder="Zoek je eigen recepten…" autocomplete="off"/>
    </div>
    <div class="p-actions">
      <span id="hello" class="small"></span>
      <button class="btn" id="logoutBtn">Uitloggen</button>
      <!-- Drop down menu for recept -->
      <div class="p-add-menu">
          <button class="btn primary" id="addBtn" aria-haspopup="true" aria-expanded="false"> Nieuw recept ▾ </button>
          <div id="addMenu" class="p-dropdown hidden" role="menu" aria-labelledby="addBtn">
            <button class="p-dropdown-item" id="btnAddOwn" role="menuitem">Eigen recept</button>
            <button class="p-dropdown-item" id="btnScrapUrl" role="menuitem">Scrap een recept</button>
          </div>
      </div>

    </div>
  </div>

  <div class="p-chips" id="chips">
    <button class="p-chip active" type="button">Alle</button>
    <button class="p-chip" type="button">Ontbijt</button>
    <button class="p-chip" type="button">Lunch</button>
    <button class="p-chip" type="button">Diner</button>
    <button class="p-chip" type="button">Vegan</button>
    <button class="p-chip" type="button">Dessert</button>
  </div>
</header>

<main class="p-masonry" id="grid" aria-live="polite"></main>

<!-- Modal -->
<div id="backdrop" class="p-backdrop">
  <div class="p-modal">
    <h2>Nieuw recept</h2>
    <div class="p-form-grid">
      <div>
        <label class="small">Titel</label>
        <input id="title" class="input" required/>
      </div>
      <div>
        <label class="small">Tijd</label>
        <input id="time" class="input" placeholder="20 min"/>
      </div>
      <div>
        <label class="small">Porties</label>
        <input id="servings" class="input" type="number" min="1" value="2"/>
      </div>

      <!-- Cat kiezer -->
      <div>
        <label class="small" for="tag">Categorie</label>
        <select id="tag" class="input">
          <option value="">Geen categorie</option>
          <option>Ontbijt</option>
          <option>Lunch</option>
          <option>Diner</option>
          <option>Vegan</option>
          <option>Dessert</option>
        </select>
      </div>

      <div class="p-full">
        <label class="small">Bron</label>
        <input id="source" class="input" type="url"/>
      </div>
      <div class="p-full">
        <label class="small">Afbeelding URL</label>
        <input id="image" class="input" type="url"/>
      </div>

      <div class="p-full">
        <label class="small" for="ingredients">Ingrediënten</label>
        <textarea id="ingredients" class="input" rows="6" placeholder="- 2 eieren
- 200 g bloem
- 1 el olijfolie"></textarea>
        <p class="small">Gebruik een <code>-</code> per ingrediënt, elk op een nieuwe regel.</p>
      </div>

      <div class="p-full">
        <label class="small" for="steps">Stappen</label>
        <textarea id="steps" class="input" rows="6" placeholder="1. Oven voorverwarmen op 180°C
2. Eieren kloppen
3. Bloem toevoegen"></textarea>
        <p class="small">Nummer elke stap; één stap per regel.</p>
      </div>

      <div class="p-full">
        <label class="small" for="notes">Notities</label>
        <textarea id="notes" class="input" rows="4" placeholder="Opmerkingen, variaties, serveertips…"></textarea>
      </div>


    </div>
    <div class="p-modal-footer">
      <button class="btn" id="cancelBtn">Annuleren</button>
      <button class="btn primary" id="saveBtn">Opslaan</button>
    </div>
  </div>
</div>

<!-- Scrap-from-URL Modal -->
<div id="scrapBackdrop" class="p-backdrop">
  <div class="p-modal">
    <h2>Scrap recept van URL</h2>
    <div class="p-form-grid">
      <div class="p-full">
        <label class="small" for="scrapUrl">Recept-URL</label>
        <input id="scrapUrl" class="input" type="url" placeholder="https://voorbeeld.nl/mijn-recept" required />
        <p class="small">De automatische scraper komt later. Voor nu kun je de URL alvast ingeven.</p>
      </div>
    </div>
    <div class="p-modal-footer">
      <button class="btn" id="scrapCancelBtn">Annuleren</button>
      <button class="btn primary" id="scrapSaveBtn">Scrap</button>
    </div>
  </div>
</div>


<script>
// helpers
function currentUser() {
  return localStorage.getItem("rp_current_user");
}

function ensureAuth() {
  const email = currentUser();
  if (!email) {
    location.href = "Aanmelden.html";
    return null;
  }
  return email;
}

function key(email) {
  return "rp_recipes_" + email;
}

function load(email) {
  try {
    return JSON.parse(localStorage.getItem(key(email))) || [];
  } catch (e) {
    return [];
  }
}

function save(email, arr) {
  localStorage.setItem(key(email), JSON.stringify(arr));
}

function pinHTML(r, i) {
  // If we have a non-empty image URL, render an <img>. Otherwise, render nothing.
  // onerror="this.remove()" prevents broken image icons by removing the <img> node if it fails to load.
  const img = (r.image && r.image.trim().length)
    ? `<img src="${r.image}" alt="${r.title}" onerror="this.remove()">`
    : "";

  // Count ingredients/steps safely (older recipes may not have these arrays).
  const ingCount = Array.isArray(r.ingredients) ? r.ingredients.length : 0;
  const stepCount = Array.isArray(r.steps) ? r.steps.length : 0;

  // Build an optional "extra" string like "3 ing • 5 stappen".
  // If either count is zero, we omit that part. If both are zero, extra becomes "".
  const extra = [ingCount ? `${ingCount} ing` : null, stepCount ? `${stepCount} stappen` : null]
    .filter(Boolean)
    .join(" • ");

  // Return the recipe "pin" as HTML. This is what gets inserted into the masonry grid.
  return `
    <article class="p-pin">
      <!-- Clickable media area; opens source in a new tab if provided, this is a comment-->
      <a class="p-media" href="${r.source || '#'}" ${r.source ? 'target="_blank" rel="noopener noreferrer"' : ''}>
        ${img}
        <!-- Action buttons (visual only for now) -->
        <div class="p-floating">
          <button class="p-icon-btn" title="Open bron">↗</button>
          <button class="p-icon-btn p-save" title="Bewaar">Bewaar</button>
        </div>
      </a>

      <div class="p-body">
        <!-- Recipe title -->
        <p class="p-title">${r.title}</p>

        <!-- Meta line:
            - Category if present (adds "Categorie • " prefix)
            - Time (or "-")
            - Servings (or "-") followed by " p"
            - Extra counts (ingredients/steps) only if available. this is a comment-->
        <p class="p-meta">
          ${r.tag ? r.tag + " • " : ""}${r.time || "-"} • ${r.servings || "-"} p${extra ? " • " + extra : ""}
        </p>

        <!-- Remove button uses the index 'i' to delete the correct recipe -->
        <button class="btn small" onclick="removeRecipe(${i})">Verwijderen</button>
      </div>
    </article>
  `;
}


function render(list) {
  const q = (document.getElementById('q').value || "").toLowerCase();
  const activeChip = document.querySelector('.p-chip.active')?.textContent || "Alle";

  const filtered = list.filter(r => {
    const matchQ = !q || (r.title || "").toLowerCase().includes(q);
    const matchC = activeChip === "Alle" || (r.tag || "").toLowerCase() === activeChip.toLowerCase();
    return matchQ && matchC;
  });

  document.getElementById('grid').innerHTML = filtered.length
    ? filtered.map((r, i) => pinHTML(r, i)).join("")
    : "<p class='small' style='padding:.75rem'>Nog geen recepten.</p>";
}

// main
const email = ensureAuth();
let list = email ? load(email) : [];

if (email) {
  document.getElementById('hello').textContent = email;
  render(list);

  document.getElementById('q').addEventListener('input', () => render(list));

  document.getElementById('chips').addEventListener('click', e => {
    if (e.target.classList.contains('p-chip')) {
      document.querySelectorAll('.p-chip').forEach(c => c.classList.remove('active'));
      e.target.classList.add('active');
      render(list);
    }
  });

  // --- Dropdown for Recipe toevoegen ---
  const modal = document.getElementById('backdrop');

  const addBtn = document.getElementById('addBtn');
  const addMenu = document.getElementById('addMenu');
  const btnAddOwn = document.getElementById('btnAddOwn');
  const btnScrapUrl = document.getElementById('btnScrapUrl');

  function toggleAddMenu() {
    addMenu.classList.toggle('hidden');
    addBtn.setAttribute('aria-expanded', addMenu.classList.contains('hidden') ? 'false' : 'true');
  }

  addBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleAddMenu();
  });

  window.addEventListener('click', (e) => {
    if (!e.target.closest('.p-add-menu')) {
      addMenu.classList.add('hidden');
      addBtn.setAttribute('aria-expanded', 'false');
    }
  });

  // “Eigen recept” uses your existing modal
  btnAddOwn.addEventListener('click', () => {
    addMenu.classList.add('hidden');
    addBtn.setAttribute('aria-expanded', 'false');
    document.getElementById('backdrop').classList.add('show');
    document.body.classList.add('no-scroll');

  });

  // “Scrap een recept” opens the URL modal
  const scrapBackdrop = document.getElementById('scrapBackdrop');
  const scrapUrlInput = document.getElementById('scrapUrl');
  const scrapCancelBtn = document.getElementById('scrapCancelBtn');
  const scrapSaveBtn = document.getElementById('scrapSaveBtn');

  btnScrapUrl.addEventListener('click', () => {
    addMenu.classList.add('hidden');
    addBtn.setAttribute('aria-expanded', 'false');
    scrapBackdrop.classList.add('show');
    document.body.classList.add('no-scroll');
    setTimeout(() => scrapUrlInput?.focus(), 0);
  });

  // Close scrap modal on backdrop click
  scrapBackdrop.addEventListener('click', (e) => {
    if (e.target === scrapBackdrop) {
      scrapBackdrop.classList.remove('show');
      document.body.classList.remove('no-scroll');
    }
  });

  scrapCancelBtn.addEventListener('click', () => {
    scrapBackdrop.classList.remove('show');
    document.body.classList.remove('no-scroll');
  });

  // For later scraping: we enqueue the URL locally so you can process it later.
  // If you prefer “do nothing”, just remove the body of submitScrapUrl().
  function enqueueScrapUrl(url) {
    const k = "rp_scrap_queue_" + email;
    let queue = [];
    try { queue = JSON.parse(localStorage.getItem(k)) || []; } catch (_) {}
    queue.unshift({ url, addedAt: new Date().toISOString() });
    localStorage.setItem(k, JSON.stringify(queue));
  }

  function submitScrapUrl() {
    const url = (scrapUrlInput.value || "").trim();
    if (!url) {
      scrapUrlInput.focus();
      return;
    }
    // Store for later processing (no scraping now)
    enqueueScrapUrl(url);

    // Reset + close
    scrapUrlInput.value = "";
    scrapBackdrop.classList.remove('show');
    document.body.classList.remove('no-scroll');
  }

scrapSaveBtn.addEventListener('click', submitScrapUrl);

  document.getElementById('cancelBtn').onclick = () => {
    modal.classList.remove('show');
    document.body.classList.remove('no-scroll'); //unlock page scroll

  };

  modal.addEventListener('click', e => {
    if (e.target === modal) {
      modal.classList.remove('show');
      document.body.classList.remove('no-scroll'); //unlock page scroll
    }
  });

  function parseBulletedList(text) {
    return (text || "")
      .split('\n')
      .map(s => s.trim())
      .filter(s => s.length > 0)
      .map(s => s.replace(/^[-•]\s*/, '')); // strip leading "-" or "•"
    }

    function parseNumberedList(text) {
      return (text || "")
        .split('\n')
        .map(s => s.trim())
        .filter(s => s.length > 0)
        .map(s => s.replace(/^\d+[\).\s-]?\s*/, '')); // strip leading "1.", "2)", "3 -", etc.
    }

document.getElementById('saveBtn').onclick = () => {
  // 0) Collect inputs (incl. new fields)
  const r = {
    title: title.value.trim(),
    time: time.value,
    servings: servings.valueAsNumber || 2,
    source: source.value,
    image: image.value,
    tag: tag.value, // from <select>, "" means "Geen categorie"
    ingredients: parseBulletedList(ingredients.value),
    steps: parseNumberedList(steps.value),
    notes: (notes.value || "").trim()
  };

  if (!r.title) { 
    title.focus(); 
    return; 
  }

  // 1) Persist + re-render
  list.unshift(r);
  save(email, list);
  render(list);

  // 2) Close the modal (this line probably already existed in your code)
  modal.classList.remove('show');

  // 3) NEW: unlock page scroll (this is the extra line you add)
  document.body.classList.remove('no-scroll');

  // 4) Reset fields
  title.value = "";
  time.value = "";
  source.value = "";
  image.value = "";
  tag.value = "";          // resets to "Geen categorie" in your <select>
  servings.value = 2;
  ingredients.value = "";
  steps.value = "";
  notes.value = "";
};


  document.getElementById('logoutBtn').onclick = () => {
    localStorage.removeItem("rp_current_user");
    location.href = "Aanmelden.html";
  };
}

function removeRecipe(i) {
  list.splice(i, 1);
  save(email, list);
  render(list);
}
</script>
</body>
</html>
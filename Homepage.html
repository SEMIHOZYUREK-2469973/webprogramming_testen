<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SeMoRecepts – Mijn recepten</title>
  <link rel="stylesheet" href="./style.css"/>
</head>
<body>

<header class="p-header">
  <div class="p-bar">
    <div class="p-brand"><span class="p-dot"></span> SeMoRecepts</div>
    <div class="p-search">
      <input id="q" type="search" placeholder="Zoek je eigen recepten…" autocomplete="off"/>
    </div>
    <div class="p-actions">
      <span id="hello" class="small"></span>
      <button class="btn" id="logoutBtn">Uitloggen</button>
      <!-- Drop down menu for recept -->
      <div class="p-add-menu">
          <button class="btn primary" id="addBtn" aria-haspopup="true" aria-expanded="false"> Nieuw recept ▾ </button>
          <div id="addMenu" class="p-dropdown hidden" role="menu" aria-labelledby="addBtn">
            <button class="p-dropdown-item" id="btnAddOwn" role="menuitem">Eigen recept</button>
            <button class="p-dropdown-item" id="btnScrapUrl" role="menuitem">Scrap een recept</button>
          </div>
      </div>

    </div>
  </div>

  <div class="p-chips" id="chips">
    <button class="p-chip active" type="button">Alle</button>
    <button class="p-chip" type="button">Ontbijt</button>
    <button class="p-chip" type="button">Lunch</button>
    <button class="p-chip" type="button">Diner</button>
    <button class="p-chip" type="button">Vegan</button>
    <button class="p-chip" type="button">Dessert</button>
  </div>
</header>

<main class="p-masonry" id="grid" aria-live="polite"></main>

<!-- Modal -->
<div id="backdrop" class="p-backdrop">
  <div class="p-modal">
    <h2>Nieuw recept</h2>
    <div class="p-form-grid">
      <div>
        <label class="small">Titel</label>
        <input id="title" class="input" required/>
      </div>
      <div>
        <label class="small">Tijd</label>
        <input id="time" class="input" placeholder="20 min"/>
      </div>
      <div>
        <label class="small">Porties</label>
        <input id="servings" class="input" type="number" min="1" value="2"/>
      </div>
      <div>
        <label class="small">Categorie</label>
        <input id="tag" class="input" placeholder="Ontbijt / Lunch"/>
      </div>
      <div class="p-full">
        <label class="small">Bron</label>
        <input id="source" class="input" type="url"/>
      </div>
      <div class="p-full">
        <label class="small">Afbeelding URL</label>
        <input id="image" class="input" type="url"/>
      </div>
    </div>
    <div class="p-modal-footer">
      <button class="btn" id="cancelBtn">Annuleren</button>
      <button class="btn primary" id="saveBtn">Opslaan</button>
    </div>
  </div>
</div>

<!-- Scrap-from-URL Modal -->
<div id="scrapBackdrop" class="p-backdrop">
  <div class="p-modal">
    <h2>Scrap recept van URL</h2>
    <div class="p-form-grid">
      <div class="p-full">
        <label class="small" for="scrapUrl">Recept-URL</label>
        <input id="scrapUrl" class="input" type="url" placeholder="https://voorbeeld.nl/mijn-recept" required />
        <p class="small">De automatische scraper komt later. Voor nu kun je de URL alvast ingeven.</p>
      </div>
    </div>
    <div class="p-modal-footer">
      <button class="btn" id="scrapCancelBtn">Annuleren</button>
      <button class="btn primary" id="scrapSaveBtn">Scrap</button>
    </div>
  </div>
</div>


<script>
// helpers
function currentUser() {
  return localStorage.getItem("rp_current_user");
}

function ensureAuth() {
  const email = currentUser();
  if (!email) {
    location.href = "Aanmelden.html";
    return null;
  }
  return email;
}

function key(email) {
  return "rp_recipes_" + email;
}

function load(email) {
  try {
    return JSON.parse(localStorage.getItem(key(email))) || [];
  } catch (e) {
    return [];
  }
}

function save(email, arr) {
  localStorage.setItem(key(email), JSON.stringify(arr));
}

function pinHTML(r, i) {
  const img = (r.image && r.image.trim().length)
    ? `<img src="${r.image}" alt="${r.title}" onerror="this.remove()">`
    : "";

  return `
    <article class="p-pin">
      <a class="p-media" href="${r.source || '#'}" ${r.source ? 'target="_blank"' : ''}>
        ${img}
        <div class="p-floating">
          <button class="p-icon-btn">↗</button>
          <button class="p-icon-btn p-save">Bewaar</button>
        </div>
      </a>
      <div class="p-body">
        <p class="p-title">${r.title}</p>
        <p class="p-meta">
          ${r.tag ? r.tag + " • " : ""}${r.time || "-"} • ${r.servings || "-"} p
        </p>
        <button class="btn small" onclick="removeRecipe(${i})">Verwijderen</button>
      </div>
    </article>
  `;
}

function render(list) {
  const q = (document.getElementById('q').value || "").toLowerCase();
  const activeChip = document.querySelector('.p-chip.active')?.textContent || "Alle";

  const filtered = list.filter(r => {
    const matchQ = !q || (r.title || "").toLowerCase().includes(q);
    const matchC = activeChip === "Alle" || (r.tag || "").toLowerCase() === activeChip.toLowerCase();
    return matchQ && matchC;
  });

  document.getElementById('grid').innerHTML = filtered.length
    ? filtered.map((r, i) => pinHTML(r, i)).join("")
    : "<p class='small' style='padding:.75rem'>Nog geen recepten.</p>";
}

// main
const email = ensureAuth();
let list = email ? load(email) : [];

if (email) {
  document.getElementById('hello').textContent = email;
  render(list);

  document.getElementById('q').addEventListener('input', () => render(list));

  document.getElementById('chips').addEventListener('click', e => {
    if (e.target.classList.contains('p-chip')) {
      document.querySelectorAll('.p-chip').forEach(c => c.classList.remove('active'));
      e.target.classList.add('active');
      render(list);
    }
  });

  // --- Dropdown for Recipe toevoegen ---
  const modal = document.getElementById('backdrop');

  const addBtn = document.getElementById('addBtn');
  const addMenu = document.getElementById('addMenu');
  const btnAddOwn = document.getElementById('btnAddOwn');
  const btnScrapUrl = document.getElementById('btnScrapUrl');

  function toggleAddMenu() {
    addMenu.classList.toggle('hidden');
    addBtn.setAttribute('aria-expanded', addMenu.classList.contains('hidden') ? 'false' : 'true');
  }

  addBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleAddMenu();
  });

  window.addEventListener('click', (e) => {
    if (!e.target.closest('.p-add-menu')) {
      addMenu.classList.add('hidden');
      addBtn.setAttribute('aria-expanded', 'false');
    }
  });

  // “Eigen recept” uses your existing modal
  btnAddOwn.addEventListener('click', () => {
    addMenu.classList.add('hidden');
    addBtn.setAttribute('aria-expanded', 'false');
    document.getElementById('backdrop').classList.add('show');
  });

  // “Scrap een recept” opens the URL modal
  const scrapBackdrop = document.getElementById('scrapBackdrop');
  const scrapUrlInput = document.getElementById('scrapUrl');
  const scrapCancelBtn = document.getElementById('scrapCancelBtn');
  const scrapSaveBtn = document.getElementById('scrapSaveBtn');

  btnScrapUrl.addEventListener('click', () => {
    addMenu.classList.add('hidden');
    addBtn.setAttribute('aria-expanded', 'false');
    scrapBackdrop.classList.add('show');
    setTimeout(() => scrapUrlInput?.focus(), 0);
  });

  // Close scrap modal on backdrop click
  scrapBackdrop.addEventListener('click', (e) => {
    if (e.target === scrapBackdrop) {
      scrapBackdrop.classList.remove('show');
    }
  });

  scrapCancelBtn.addEventListener('click', () => {
    scrapBackdrop.classList.remove('show');
  });

  // For later scraping: we enqueue the URL locally so you can process it later.
  // If you prefer “do nothing”, just remove the body of submitScrapUrl().
  function enqueueScrapUrl(url) {
    const k = "rp_scrap_queue_" + email;
    let queue = [];
    try { queue = JSON.parse(localStorage.getItem(k)) || []; } catch (_) {}
    queue.unshift({ url, addedAt: new Date().toISOString() });
    localStorage.setItem(k, JSON.stringify(queue));
  }

  function submitScrapUrl() {
    const url = (scrapUrlInput.value || "").trim();
    if (!url) {
      scrapUrlInput.focus();
      return;
    }
    // Store for later processing (no scraping now)
    enqueueScrapUrl(url);

    // Reset + close
    scrapUrlInput.value = "";
    scrapBackdrop.classList.remove('show');
  }

scrapSaveBtn.addEventListener('click', submitScrapUrl);

  document.getElementById('cancelBtn').onclick = () => {
    modal.classList.remove('show');
  };

  modal.addEventListener('click', e => {
    if (e.target === modal) {
      modal.classList.remove('show');
    }
  });

  document.getElementById('saveBtn').onclick = () => {
    const r = {
      title: title.value.trim(),
      time: time.value,
      servings: servings.valueAsNumber || 2,
      source: source.value,
      image: image.value,
      tag: tag.value
    };

    if (!r.title) {
      return title.focus();
    }

    list.unshift(r);
    save(email, list);
    render(list);
    modal.classList.remove('show');

    title.value = "";
    time.value = "";
    source.value = "";
    image.value = "";
    tag.value = "";
    servings.value = 2;
  };

  document.getElementById('logoutBtn').onclick = () => {
    localStorage.removeItem("rp_current_user");
    location.href = "Aanmelden.html";
  };
}

function removeRecipe(i) {
  list.splice(i, 1);
  save(email, list);
  render(list);
}
</script>
</body>
</html>